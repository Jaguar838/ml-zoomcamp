## Домашнє завдання

У цьому домашньому завданні ми розгорнемо модель "бджоли проти ос", яку ми тренували в  
[попередньому завданні](../../cohorts/2024/08-deep-learning/homework.md).

Завантажте модель за цим посиланням:

https://github.com/alexeygrigorev/large-datasets/releases/download/hairstyle/model_2024_hairstyle.keras

---

## Запитання 1

Перетворіть цю модель з формату Keras у формат TF-Lite.

Який розмір **перетвореної** моделі?

- 27 МБ
- 43 МБ
- 77 МБ
- 127 МБ

---

## Запитання 2

Щоб використовувати цю модель, нам потрібно знати індекс вхідного та індекс вихідного шарів.

Який індекс виходу цієї моделі?

- 3
- 7
- 13
- 24

---

## Підготовка зображення

Вам знадобиться код для завантаження та зміни розміру зображень. Ви можете використовувати цей код:

```python
from io import BytesIO
from urllib import request

from PIL import Image

def download_image(url):
    with request.urlopen(url) as resp:
        buffer = resp.read()
    stream = BytesIO(buffer)
    img = Image.open(stream)
    return img


def prepare_image(img, target_size):
    if img.mode != 'RGB':
        img = img.convert('RGB')
    img = img.resize(target_size, Image.NEAREST)
    return img
```

Для цього необхідно встановити бібліотеку `pillow`:

```bash
pip install pillow
```

Завантажте та змініть розмір цього зображення:

https://habrastorage.org/webt/yf/_d/ok/yf_dokzqy3vcritme8ggnzqlvwa.jpeg

На основі попереднього завдання, яким має бути цільовий розмір зображення?

---

## Запитання 3

Тепер потрібно перетворити зображення у numpy-масив і виконати попередню обробку.

> Підказка: перевірте попереднє завдання. Яка була попередня обробка там?

Після обробки, яке значення має перший піксель у каналі R?

- 0.24
- 0.44
- 0.64
- 0.84

---

## Запитання 4

Застосуйте модель до цього зображення. Який результат моделі?

- 0.293
- 0.493
- 0.693
- 0.893

---

## Підготовка коду для Lambda

Скопіюйте весь код у окремий файл Python. Вам знадобиться цей файл для наступних двох запитань.

> Підказка: ви можете протестувати цей файл локально за допомогою `ipython` або Jupyter Notebook, імпортувавши файл і викликавши функції з нього.

---

## Docker

Для наступних двох запитань ми будемо використовувати Docker-образ, який вже підготовлено.  
Ось Dockerfile, який використовувався для створення цього образу:

```docker
FROM public.ecr.aws/lambda/python:3.10

COPY model_2024_hairstyle_v2.tflite .

RUN pip install numpy==1.23.1
```

Зверніть увагу, що використовується Python 3.10. Останні версії моделей TF Lite не підтримують Python 3.12, тому потрібно використовувати 3.10. Також для цієї частини використовується TensorFlow 2.14.0. Ми протестували, і моделі, створені з версією 2.17, можна запускати на 2.14.0.

Для цього образу також потрібна стара версія numpy (1.23.1).

Docker-образ опубліковано тут: [`agrigorev/model-2024-hairstyle:v3`](https://hub.docker.com/r/agrigorev/model-2024-hairstyle/tags).

---

## Запитання 5

Завантажте базовий образ `agrigorev/model-2024-hairstyle:v3`. Ви можете зробити це за допомогою команди [`docker pull`](https://docs.docker.com/engine/reference/commandline/pull/).

Який розмір цього базового образу?

- 182 МБ
- 382 МБ
- 582 МБ
- 782 МБ

---

## Запитання 6

Розширте цей Docker-образ, встановіть усі необхідні бібліотеки  
і додайте код для Lambda.

Не потрібно включати модель у образ — вона вже включена.  
Ім'я файлу з моделлю — `model-2024-hairstyle-v2.tflite`, і він знаходиться  
в робочій директорії образу (див. Dockerfile вище для довідки).  
Для обробки зображень використовуйте ті ж розміри цільового зображення і масштабування діапазону значень, що й у завданні 8.

Запустіть контейнер локально.

Обробіть це зображення: https://habrastorage.org/webt/yf/_d/ok/yf_dokzqy3vcritme8ggnzqlvwa.jpeg

Який вихід моделі?

- 0.229
- 0.429
- 0.629
- 0.829

---

## Розгортання на AWS

Тепер ви можете розгорнути вашу модель на AWS!

- Опублікуйте ваш образ у ECR.
- Створіть функцію Lambda на AWS, використовуючи образ із ECR.
- Виділіть більше оперативної пам’яті та збільшіть час очікування.
- Протестуйте функцію.
- Опублікуйте її за допомогою API Gateway.

Це необов'язково і не оцінюється.

---

## Публікація на Docker Hub

Для довідки, ось як ми публікували наш образ на Docker Hub:

```bash
docker build -t model-2024-hairstyle -f homework.dockerfile .
docker tag model-2024-hairstyle:latest agrigorev/model-2024-hairstyle:v3
docker push agrigorev/model-2024-hairstyle:v3
```

(Цей код виконувати не потрібно)

---

## Надання результатів

- Надішліть ваші результати сюди: https://courses.datatalks.club/ml-zoomcamp-2024/homework/hw09
- Якщо ваша відповідь не точно збігається з варіантами, оберіть найближчий.